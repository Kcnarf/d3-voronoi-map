!function(t,n){"object"==typeof exports&&"undefined"!=typeof module?n(exports,require("d3-polygon"),require("d3-timer"),require("d3-dispatch"),require("d3-weighted-voronoi")):"function"==typeof define&&define.amd?define(["exports","d3-polygon","d3-timer","d3-dispatch","d3-weighted-voronoi"],n):n(t.d3=t.d3||{},t.d3,t.d3,t.d3,t.d3)}(this,function(t,n,e,i,r){"use strict";function o(){this.growthChangesLength=f,this.totalAvailableArea=NaN,this.lastAreaError=NaN,this.lastGrowth=NaN,this.growthChanges=[],this.growthChangeWeights=h(this.growthChangesLength),this.growthChangeWeightsSum=g(this.growthChangeWeights)}function a(t,n){return t>=n?1:-1}function h(t){for(var n=3,e=1,i=1,r=n,o=[],a=0;a<t;a++)o.push(r),r-=e,r<i&&(r=i);return o}function g(t){for(var n=0,e=0;e<t.length;e++)n+=t[e];return n}function s(){function t(t,a,g,l){var c,f,p=!1;for(i!==l.clip()&&(i=l.clip(),r=l.extent(),p=!0),p&&e(),c=o+s*l.prng()(),f=h+u*l.prng()();!n.polygonContains(i,[c,f]);)c=o+s*l.prng()(),f=h+u*l.prng()();return[c,f]}function e(){o=r[0][0],a=r[1][0],h=r[0][1],g=r[1][1],s=a-o,u=g-h}var i,r,o,a,h,g,s,u;return t}function u(){function t(t,n,i,r){var h=!1;return o!==r.clip()&&(o=r.clip(),h|=!0),a!==i&&(a=i,h|=!0),h&&e(),[g[0]+Math.cos(l+n*u)*s+.001*(r.prng()()-.5),g[1]+Math.sin(l+n*u)*s+.001*(r.prng()()-.5)]}function e(){g=n.polygonCentroid(o),s=i(g,o)/2,h=a.length,u=2*Math.PI/h}function i(t,n){for(var e,i=1/0,o=0,a=n[n.length-1],h=n[o];o<n.length;)e=r(t,a,h),e<i&&(i=e),o++,a=h,h=n[o];return i}function r(t,n,e){var i=t[0],r=t[1],o=n[0],a=n[1],h=e[0],g=e[1],s=i-o,u=r-a,l=h-o,c=g-a,f=s*l+u*c,p=l*l+c*c,w=-1;0!=p&&(w=f/p);var d,v;w<0?(d=o,v=a):w>1?(d=h,v=g):(d=o+w*l,v=a+w*c);var C=i-d,y=r-v;return Math.sqrt(C*C+y*y)}var o,a,h,g,s,u,l=0;return t.startAngle=function(n){return arguments.length?(l=n,t):l},t}function l(){function t(t,n,o,a){var g=!1;return i!==a.clip()&&(i=a.clip(),g|=!0),r!==o&&(r=o,g|=!0),g&&e(),h}function e(){o=r.length,a=n.polygonArea(i),h=a/o/2}var i,r,o,a,h;return t}function c(t){function a(t){return Math.pow(t,2)}function h(t,n){return a(n.x-t.x)+a(n.y-t.y)}function g(){u(),X.call("tick",j),P&&(U.stop(),X.call("end",j))}function u(){P||(T&&c(),W=w(W,Q.ratio()),N++,k=A(W),Q.add(k),L=k<x,P=L||N>=_)}function c(){m(),b=t.length,M=Math.abs(n.polygonArea(K.clip())),x=V*M,Q.clear().totalArea(M),N=0,L=!1,W=f(t,j),P=!1,T=!1}function f(t,n){var e,i,r=t.reduce(function(t,n){return Math.max(t,z(n))},-(1/0)),o=r*D;return e=t.map(function(t,e,i){return{index:e,weight:Math.max(z(t),o),initialPosition:H(t,e,i,n),initialWeight:J(t,e,i,n),originalData:t}}),i=p(e,n),K(i)}function p(t,e){var i,r=t.reduce(function(t,n){return t+=n.weight},0);return t.map(function(t,o,a){return i=t.initialPosition,n.polygonContains(K.clip(),i)||(i=S(t,o,a,e)),{index:t.index,targetedArea:M*t.weight/r,data:t,x:i[0],y:i[1],weight:t.initialWeight}})}function w(t,n){var e;return d(t,n),e=t.map(function(t){return t.site.originalObject}),t=K(e),t.length<b&&console.log("at least 1 site has no area, which is not supposed to arise"),v(t,n),e=t.map(function(t){return t.site.originalObject}),t=K(e),t.length<b&&console.log("at least 1 site has no area, which is not supposed to arise"),t}function d(t,e){var i,r,o,a,h,g,s,u=[],l=.5;i=l*e,r=1-i;for(var c=0;c<b;c++)o=t[c],a=o.site.originalObject,h=n.polygonCentroid(o),g=h[0]-a.x,s=h[1]-a.y,g*=r,s*=r,a.x+=g,a.y+=s,u.push(a);E(u)}function v(t,e){var i,r,o,a,h,g,s=[],u=.1;i=u*e;for(var l=0;l<b;l++)r=t[l],o=r.site.originalObject,a=n.polygonArea(r),h=o.targetedArea/a,h=Math.max(h,1-u+i),h=Math.min(h,1+u-i),g=o.weight*h,g=Math.max(g,R),o.weight=g,s.push(o);E(s)}function C(t){var n,e,i,r,o,a,g,s=0;do{n=!1;for(var u=0;u<b;u++){e=t[u];for(var l=u+1;l<b;l++)if(i=t[l],e.weight>i.weight?(r=e,o=i):(r=i,o=e),a=h(e,i),a<r.weight-o.weight){g=a+o.weight/2,g=Math.max(g,R),r.weight=g,n=!0,s++;break}if(n)break}}while(n)}function y(t){var n,e,i,r,o,a,g,s=0;do{n=!1;for(var u=0;u<b;u++){e=t[u];for(var l=u+1;l<b;l++)if(i=t[l],e.weight>i.weight?(r=e,o=i):(r=i,o=e),a=h(e,i),a<r.weight-o.weight){g=r.weight-o.weight-a,o.weight+=g+R,n=!0,s++;break}if(n)break}}while(n)}function A(t){for(var e,i,r,o=0,a=0;a<b;a++)e=t[a],i=e.site.originalObject,r=n.polygonArea(e),o+=Math.abs(i.targetedArea-r);return o}function m(){switch(Y){case 0:E=C;break;case 1:E=y;break;default:console.log("Variant of 'handleOverweighted' is unknown")}}var b,M,x,N,W,k,L,P,j,E,O=.01,G=50,I=.01,q=Math.random,S=s(),F=l(),R=(s(),1),z=function(t){return t.weight},V=O,_=G,D=I,B=q,H=S,J=F,K=r.weightedVoronoi(),Q=new o,T=!0,U=e.timer(g),X=i.dispatch("tick","end"),Y=1;return j={tick:u,restart:function(){return U.restart(g),j},stop:function(){return U.stop(),j},weight:function(t){return arguments.length?(z=t,T=!0,j):z},convergenceRatio:function(t){return arguments.length?(V=t,T=!0,j):V},maxIterationCount:function(t){return arguments.length?(_=t,j):_},minWeightRatio:function(t){return arguments.length?(D=t,T=!0,j):D},clip:function(t){return arguments.length?(K.clip(t),T=!0,j):K.clip()},extent:function(t){return arguments.length?(K.extent(t),T=!0,j):K.extent()},size:function(t){return arguments.length?(K.size(t),T=!0,j):K.size()},prng:function(t){return arguments.length?(B=t,T=!0,j):B},initialPosition:function(t){return arguments.length?(H=t,T=!0,j):H},initialWeight:function(t){return arguments.length?(J=t,T=!0,j):J},state:function(){return{ended:P,iterationCount:N,convergenceRatio:k/M,polygons:W}},on:function(t,n){return 1===arguments.length?X.on(t):(X.on(t,n),j)}},c(),j}var f=10;o.prototype.reset=function(){return this.lastAreaError=NaN,this.lastGrowth=NaN,this.growthChanges=[],this.growthChangesLength=f,this.growthChangeWeights=h(this.growthChangesLength),this.growthChangeWeightsSum=g(this.growthChangeWeights),this.totalAvailableArea=NaN,this},o.prototype.clear=function(){return this.lastAreaError=NaN,this.lastGrowth=NaN,this.growthChanges=[],this},o.prototype.length=function(t){return arguments.length?(parseInt(t)>0?(this.growthChangesLength=Math.floor(parseInt(t)),this.growthChangeWeights=h(this.growthChangesLength),this.growthChangeWeightsSum=g(this.growthChangeWeights)):console.warn("FlickeringMitigation.length() accepts only positive integers; unable to handle "+t),this):this.growthChangesLength},o.prototype.totalArea=function(t){return arguments.length?(parseFloat(t)>0?this.totalAvailableArea=parseFloat(t):console.warn("FlickeringMitigation.totalArea() accepts only positive numbers; unable to handle "+t),this):this.totalAvailableArea},o.prototype.add=function(t){var n,e;return n=this.lastAreaError,this.lastAreaError=t,isNaN(n)||(e=this.lastGrowth,this.lastGrowth=a(this.lastAreaError,n)),isNaN(e)||this.growthChanges.unshift(this.lastGrowth!=e),this.growthChanges.length>this.growthChangesLength&&this.growthChanges.pop(),this},o.prototype.ratio=function(){var t,n=0;if(this.growthChanges.length<this.growthChangesLength)return 0;if(this.lastAreaError>this.totalAvailableArea/10)return 0;for(var e=0;e<this.growthChangesLength;e++)this.growthChanges[e]&&(n+=this.growthChangeWeights[e]);return t=n/this.growthChangeWeightsSum,t>0&&console.log("flickering mitigation ratio: "+Math.floor(1e3*t)/1e3),t},t.voronoiMapSimulation=c,t.voronoiMapInitialPositionRandom=s,t.voronoiMapInitialPositionPie=u,Object.defineProperty(t,"__esModule",{value:!0})});